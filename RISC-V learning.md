# RISC-V

### PMP(Physical Memory Protection)

物理内存保护机制，用于实现不同执行环境之间的隔离，通过配置寄存器来定义内存区域的访问权限（读、写、执行），确保只有经过授权的代码才能访问特定的内存区域。

PMP配置涉及的寄存器：

1. **pmpcfg寄存器**：用于配置PMP区域的权限和模式；
2. **pmpaddr寄存器**：用于定义PMP区域的边界。

**TOR模式**：使用两个连续的`pmpaddr`寄存器定义一个区域，第一个寄存器定义区域的起始地址，第二个寄存器定义区域的结束地址（加1）。

- 区域0由`pmpaddr0`（起始地址）和`pmpaddr1`（结束地址+1）定义。
- 区域1由`pmpaddr2`（起始地址）和`pmpaddr3`（结束地址+1）定义。

通过这种方式，PMP能够知道每对连续的`pmpaddr`寄存器定义的内存区域，从而实现精确的内存保护和访问控制。每个区域的权限通过对应的`pmpcfg`寄存器配置。

```nasm
# 设置pmpaddr0为0x80000000 >> 2
li t0, 0x80000000
srl t0, t0, 2
csrw pmpaddr0, t0

# 设置pmpaddr1为0x80001000 >> 2
li t1, 0x80001000
srl t1, t1, 2
csrw pmpaddr1, t1

# 设置pmpcfg0为区域0的只读权限和TOR模式
li t2, 0x8F  # 10001111b, A=TOR, R=1, W=0, X=0
csrw pmpcfg0, t2
```

---

### sPMP(Supervisor Physical Memory Protection)

sPMP是一种增强的内存保护机制，通过sPMP，系统可以定义和控制内核和用户态的内存访问权限，确保安全性和隔离性。

**sPMP配置寄存器（sPMPcfg）**：类似于PMP配置寄存器（pmpcfg）

**sPMP地址寄存器（sPMPaddr）**：类似于PMP地址寄存器（pmpaddr），通过以下方式控制权限

- **读权限（R）**：是否允许读取内存区域。
- **写权限（W）**：是否允许写入内存区域。
- **执行权限（X）**：是否允许执行内存区域中的代码。
- **用户态权限（U）**：是否允许用户态访问内存区域。

sPMP支持几种地址匹配模式，例如NA4、NAPOT和TOR，类似于PMP。不同的是，sPMP主要用于定义`内核态`的内存区域。

```nasm
li t0, 0x80000000
srl t0, t0, 2
csrw spmpaddr0, t0

li t1, 0x80001000
srl t1, t1, 2
csrw spmpaddr1, t1

# 配置sPMP权限为内核态只读（用户态无法访问），使用TOR模式
li t2, 0x8F  # 10001111b, A=TOR, R=1, W=0, X=0, U=0（用户态无访问权限）
csrw spmpcfg0, t2
```

---

### MTT(Memory Type and Protection)

MTT主要通过以下几个方面来管理内存类型和保护属性：

1. **内存类型**：
    - 定义内存的缓存属性，如缓存可用、不可缓存、设备内存等。
    - 这些属性决定了内存访问时的数据缓存策略和一致性行为。
2. **访问权限**：
    - 定义内存区域的访问权限，例如读、写、执行权限。
    - 通过访问权限控制，可以确保只有经过授权的代码才能访问特定的内存区域，从而提高系统安全性。
3. **地址匹配**：
    - MTT使用类似PMP的地址匹配机制来定义内存区域。地址匹配模式包括NA4（自然对齐的4字节）、NAPOT（自然对齐的2的幂大小）和TOR（Top of Range）。

假设我们要配置一个从地址`0x90000000`开始，大小为4KB的内存区域，将其设置为不可缓存的设备内存，并设置访问权限为只读。

```nasm
# 设置内存区域0：起始地址 0x90000000，大小 4KB，不可缓存，只读
li t0, 0x90000000       # 加载起始地址到寄存器 t0
srl t0, t0, 2           # 右移2位以符合地址寄存器格式
csrw mttaddr0, t0       # 写入 mttaddr0 寄存器

li t1, 0x90001000       # 加载结束地址（+1）到寄存器 t1
srl t1, t1, 2           # 右移2位以符合地址寄存器格式
csrw mttaddr1, t1       # 写入 mttaddr1 寄存器

li t2, 0x4F             # 配置 mttcfg0：A=TOR, R=1可读取, W=0不可写入, X=0不可执行, C=0不可缓存
csrw mttcfg0, t2        # 写入 mttcfg0 寄存器
```